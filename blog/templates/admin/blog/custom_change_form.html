{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    #id_content_toolbar button {
        margin-right: 5px;
        padding: 5px 10px;
    }
    #id_content_editor {
        border: 1px solid #ccc;
        min-height: 300px;
        padding: 10px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var toolbar = document.createElement('div');
    toolbar.id = 'id_content_toolbar';
    var textarea = document.getElementById('id_content');
    textarea.parentNode.insertBefore(toolbar, textarea);

    var buttons = [
        { name: 'Bold', action: '**', icon: 'B' },
        { name: 'Italic', action: '*', icon: 'I' },
        { name: 'Link', action: '[](url)', icon: 'üîó' },
        { name: 'Code', action: '`', icon: '<>' },
        { name: 'Preview', action: 'preview', icon: 'üëÅÔ∏è' }
    ];

    buttons.forEach(function(button) {
        var btn = document.createElement('button');
        btn.textContent = button.icon;
        btn.type = 'button';
        btn.onclick = function() {
            if (button.action === 'preview') {
                togglePreview();
            } else {
                wrapText(editor, button.action);
            }
            editor.focus();
            updateTextarea();
        };
        toolbar.appendChild(btn);
    });

    textarea.style.display = 'none';
    var editor = document.createElement('div');
    editor.id = 'id_content_editor';
    editor.contentEditable = true;
    editor.textContent = textarea.value;
    textarea.parentNode.insertBefore(editor, textarea.nextSibling);

    function updateTextarea() {
        textarea.value = editor.textContent;
    }

    editor.oninput = updateTextarea;
    editor.onblur = updateTextarea;

    function wrapText(element, wrapper) {
        var selection = window.getSelection();
        var range = selection.getRangeAt(0);
        var content = range.extractContents();
        var span = document.createElement('span');
        span.textContent = wrapper + content.textContent + wrapper;
        range.insertNode(span);
        updateTextarea();
    }

    var previewMode = false;
    function togglePreview() {
        if (previewMode) {
            editor.innerHTML = editor.textContent;
            editor.contentEditable = true;
            previewMode = false;
        } else {
            editor.innerHTML = marked.parse(editor.textContent);
            editor.contentEditable = false;
            previewMode = true;
        }
    }

    // Handle pasting
    editor.addEventListener('paste', function(e) {
        e.preventDefault();
        var clipboardData = e.clipboardData || window.clipboardData;
        var pastedData = clipboardData.getData('Text');

        // Insert the text content
        document.execCommand('insertText', false, pastedData);

        updateTextarea();
    });

    // Handle form submission
    var form = textarea.form;
    form.onsubmit = function() {
        updateTextarea();
    };
});
</script>
{% endblock %}